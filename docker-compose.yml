services:
  brstack_app:
    image: brstack_app:latest
    build:
      context: .
      dockerfile: Dockerfile
      tags:
        - brstack_app:latest
    profiles:
      - build_only

  client:
    image: brstack_app:latest
    cap_add:
     - NET_ADMIN # nftablesを使用するために必要
     - NET_RAW # raw socketを使用するために必要
    environment:
      - DST=192.168.1.2
      - ROUTING=192.168.0.0/24 0.0.0.0 192.168.1.0/24 192.168.0.3
    networks:
      client_router:
        ipv4_address: 192.168.0.2
  
  router:
    image: brstack_app:latest
    cap_add:
     - NET_ADMIN # nftablesを使用するために必要
     - NET_RAW # raw socketを使用するために必要
    environment:
      - ROUTING=192.168.1.0/24 0.0.0.0 192.168.0.0/24 0.0.0.0
    networks:
      client_router:
        ipv4_address: 192.168.0.3
      router_server:
        ipv4_address: 192.168.1.3

  server:
    image: brstack_app:latest
    cap_add:
     - NET_ADMIN # nftablesを使用するために必要
     - NET_RAW # raw socketを使用するために必要
    environment:
      - ROUTING=192.168.1.0/24 0.0.0.0 192.168.0.0/24 192.168.1.3
    networks:
      router_server:
        ipv4_address: 192.168.1.2

networks:
  client_router:
    ipam:
      config:
        - subnet: 192.168.0.0/24
  router_server:
    ipam:
      config:
        - subnet: 192.168.1.0/24
